<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Course - Mentoring</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/main9.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
            <div class="logo-container">
                <div class="logo"></div>
                <h1>Mentoring</h1>
            </div>
            <div class="nav-links">
                <a href="mentor.html">Dashboard</a>
                <a href="business.html" class="active">My Business</a>
            </div>
        </div>
        <div class="nav-right">
            <a href="#" class="signout-btn" id="signoutBtn">Sign Out</a>
        </div>
    </nav>

    <main class="mentor-content">
        <div class="course-creation-sections">
            <a href="#overview" class="section-link">
                <span class="number">1</span>
                <i class="fas fa-arrow-right"></i>
                <span>Overview</span>
            </a>
            <a href="#pricing" class="section-link">
                <span class="number">2</span>
                <i class="fas fa-arrow-right"></i>
                <span>Pricing</span>
            </a>
            <a href="#gallery" class="section-link">
                <span class="number">3</span>
                <i class="fas fa-arrow-right"></i>
                <span>Gallery</span>
            </a>
            <a href="#publish" class="section-link">
                <span class="number">4</span>
                <i class="fas fa-arrow-right"></i>
                <span>Publish</span>
            </a>
            <button class="save-course-btn">Save</button>
        </div>

        <div class="course-form-section">
            <div class="form-group">
                <label for="courseTitle">Course Title</label>
                <input type="text" id="courseTitle" placeholder="Enter your course title" class="course-input">
            </div>
            
            <div class="form-group">
                <label for="courseCategory">Category</label>
                <div class="custom-select">
                    <div class="select-header" id="categoryHeader">
                        <span>Select a category</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="select-options" id="categoryOptions">
                        <div class="option">Introduction to Digital Marketing</div>
                        <div class="option">Basics of Web Development</div>
                        <div class="option">Mastering Public Speaking</div>
                        <div class="option">Creative Writing for Beginners</div>
                        <div class="option">Fundamentals of Data Analysis</div>
                        <div class="option">Time Management and Productivity</div>
                        <div class="option">Photography Essentials</div>
                        <div class="option">Entrepreneurship 101</div>
                        <div class="option">Excel for Everyday Use</div>
                        <div class="option">Understanding Personal Finance</div>
                        <div class="option">CSS Mastery: From Beginner to Advanced</div>
                        <div class="option">Responsive Web Design with Flexbox & Grid</div>
                        <div class="option">UI/UX Design Fundamentals with CSS</div>
                        <div class="option">Building Modern Websites with HTML & CSS</div>
                        <div class="option">Animations and Transitions in CSS</div>
                        <div class="option">Foundations of Physics for Class 12</div>
                        <div class="option">Mathematics for Higher Secondary</div>
                        <div class="option">Intro to Economics and Business Studies</div>
                        <div class="option">Board Exam Preparation: Science Stream</div>
                        <div class="option">Career Planning After Class 12</div>
                        <div class="option">AI & Machine Learning Basics</div>
                        <div class="option">Building Your Personal Brand Online</div>
                        <div class="option">Freelancing and Remote Work Essentials</div>
                        <div class="option">Introduction to Cloud Computing</div>
                        <div class="option">Cybersecurity Awareness for Everyone</div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="courseDescription">Description (50 words max)</label>
                <textarea 
                    id="courseDescription" 
                    class="course-description" 
                    placeholder="Enter your course description"
                    maxlength="250"
                ></textarea>
                <div class="char-count"><span id="wordCount">0</span>/50 words</div>
            </div>

            <div class="form-navigation">
                <button class="next-btn">
                    Next
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <div class="course-form-section" id="pricingSection" style="display: none;">
            <div class="pricing-table">
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th>Basic</th>
                            <th>Normal</th>
                            <th>Premium</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Days</td>
                            <td><input type="number" class="pricing-input" min="1" placeholder="Enter days"></td>
                            <td><input type="number" class="pricing-input" min="1" placeholder="Enter days"></td>
                            <td><input type="number" class="pricing-input" min="1" placeholder="Enter days"></td>
                        </tr>
                        <tr>
                            <td>Price (â‚¹)</td>
                            <td><input type="number" class="pricing-input" min="0" placeholder="Enter price"></td>
                            <td><input type="number" class="pricing-input" min="0" placeholder="Enter price"></td>
                            <td><input type="number" class="pricing-input" min="0" placeholder="Enter price"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="form-navigation">
                <button class="next-btn">
                    Next
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <div class="course-form-section" id="gallerySection" style="display: none;">
            <div class="gallery-upload">
                <label for="courseImage" class="upload-area">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>Upload Course Image</h3>
                    <p>Drag and drop your image here or click to browse</p>
                    <input type="file" id="courseImage" accept="image/*" hidden>
                </label>
                <div class="image-preview" id="imagePreview"></div>
            </div>

            <div class="form-navigation">
                <button class="next-btn">
                    Next
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <div class="course-form-section" id="publishSection" style="display: none;">
            <div class="publish-container">
                <button id="publishBtn" class="publish-btn">
                    <i class="fas fa-upload"></i>
                    Publish Course
                </button>
            </div>

            <script>
            document.getElementById('publishBtn').addEventListener('click', async () => {
                const courseData = {
                    title: document.getElementById('courseTitle').value,
                    description: document.getElementById('courseDescription').value,
                    category: document.getElementById('courseCategory').value,
                    duration: document.getElementById('courseDuration').value,
                    price: document.getElementById('coursePrice').value,
                    level: document.getElementById('courseLevel').value,
                    thumbnail: document.getElementById('courseThumbnail').value
                };

                try {
                    const response = await fetch('/api/courses/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(courseData)
                    });

                    if (response.ok) {
                        window.location.href = '/dashboard';
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            });
            </script>
        </div>
    </main>

    <script>
        document.getElementById('signoutBtn').addEventListener('click', () => {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        });

        // Custom dropdown functionality
        const categoryHeader = document.getElementById('categoryHeader');
        const categoryOptions = document.getElementById('categoryOptions');
        const options = document.querySelectorAll('.option');

        categoryHeader.addEventListener('click', () => {
            categoryOptions.style.display = categoryOptions.style.display === 'block' ? 'none' : 'block';
            categoryHeader.classList.toggle('active');
        });

        options.forEach(option => {
            option.addEventListener('click', () => {
                categoryHeader.querySelector('span').textContent = option.textContent;
                categoryOptions.style.display = 'none';
                categoryHeader.classList.remove('active');
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-select')) {
                categoryOptions.style.display = 'none';
                categoryHeader.classList.remove('active');
            }
        });
    </script>

    <script>
        // Section navigation handling
        // Add to your existing script
        const courseImage = document.getElementById('courseImage');
        const imagePreview = document.getElementById('imagePreview');
        
        courseImage.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    imagePreview.innerHTML = '';
                    imagePreview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Update section navigation to include gallery and publish
        document.querySelectorAll('.section-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                
                // Remove active class from all links
                document.querySelectorAll('.section-link').forEach(l => {
                    l.classList.remove('active');
                });
                
                // Add active class to clicked link
                link.classList.add('active');
                
                // Hide all sections
                document.querySelectorAll('.course-form-section').forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show target section
                if (targetId === 'pricing') {
                    document.getElementById('pricingSection').style.display = 'block';
                } else if (targetId === 'overview') {
                    document.querySelector('.course-form-section:not(#pricingSection)').style.display = 'block';
                } else if (targetId === 'gallery') {
                    document.getElementById('gallerySection').style.display = 'block';
                } else if (targetId === 'publish') {
                    document.getElementById('publishSection').style.display = 'block';
                }
            });
        });
    
        // Input validation for pricing
        document.querySelectorAll('.pricing-input').forEach(input => {
            input.addEventListener('input', (e) => {
                // Remove non-numeric characters
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                
                // Ensure positive numbers only
                if (e.target.value < 0) e.target.value = 0;
            });
        });
    
        // Next button functionality
        document.querySelectorAll('.next-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const currentSection = btn.closest('.course-form-section');
                const currentLink = document.querySelector('.section-link.active');
                const nextLink = currentLink.nextElementSibling;
                
                if (nextLink && nextLink.classList.contains('section-link')) {
                    nextLink.click();
                }
            });
        });
    </script>

    <script>
        const description = document.getElementById('courseDescription');
        const wordCount = document.getElementById('wordCount');
        const maxWords = 50;

        description.addEventListener('input', () => {
            const words = description.value.trim().split(/\s+/).filter(word => word.length > 0);
            const count = words.length;
            wordCount.textContent = count;
            
            if (count > maxWords) {
                const truncated = words.slice(0, maxWords).join(' ');
                description.value = truncated;
                wordCount.parentElement.classList.add('limit');
            } else {
                wordCount.parentElement.classList.remove('limit');
            }
        });
    </script>

    <script>
        // Add validation functions
        function validateOverview(overview) {
            return overview.title.trim() !== '' && 
                   overview.category !== 'Select a category' && 
                   overview.description.trim() !== '';
        }

        function validatePricing(pricing) {
            try {
                return Object.values(pricing).every(tier => 
                    tier.days && tier.price && 
                    parseInt(tier.days) > 0 && 
                    parseInt(tier.price) >= 0
                );
            } catch (error) {
                return false;
            }
        }

        function validateGallery(gallery) {
            return gallery && gallery.image;
        }

        function showSuccessMessage() {
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.innerHTML = `
                <div class="success-content">
                    <i class="fas fa-check-circle"></i>
                    <h3>Course Published Successfully!</h3>
                    <p>Your course has been saved to your collection.</p>
                    <button onclick="window.location.href='business.html'">View My Courses</button>
                </div>
            `;
            document.body.appendChild(successMessage);
        }

        // Debug function to check stored data
        function checkStoredData() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                if (!currentUser) {
                    console.log('No user logged in');
                    return;
                }

                console.log('Current User:', currentUser);

                // Get all users data with correct collection name
                const users = JSON.parse(localStorage.getItem('Mentoring.User')) || [];
                const userIndex = users.findIndex(user => user.id === currentUser.id);
                
                if (userIndex === -1) {
                    console.log('User not found in database');
                    return;
                }

                console.log('User Data:', users[userIndex]);
                console.log('Courses:', users[userIndex].courses);
            } catch (error) {
                console.error('Error checking stored data:', error);
            }
        }

        // Publish button click handler
        // Update initializeUserData function
        function initializeUserData() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                if (!currentUser || !currentUser.id) {
                    console.error('No mentor session found');
                    localStorage.removeItem('user');
                    window.location.href = 'index.html';
                    return false;
                }
        
                let mentors = JSON.parse(localStorage.getItem('mentors')) || [];
                let mentorIndex = mentors.findIndex(mentor => mentor.id === currentUser.id);
            
                if (mentorIndex === -1) {
                    const newMentor = {
                        id: currentUser.id,
                        email: currentUser.email,
                        name: currentUser.name,
                        role: currentUser.role || 'mentor',
                        courses: [],
                        createdAt: new Date().toISOString()
                    };
                    mentors.push(newMentor);
                    localStorage.setItem('mentors', JSON.stringify(mentors));
                    console.log('New mentor entry created:', newMentor);
                }
                return true;
            } catch (error) {
                console.error('Error in initializeUserData:', error);
                return false;
            }
        }
        
        // Update publish button handler
        // Add this function before the publish button handler
        function resizeImage(imgSrc) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 600;
                    let width = img.width;
                    let height = img.height;
        
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
        
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = imgSrc;
            });
        }
        
        document.querySelector('.publish-btn').addEventListener('click', async function() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                if (!currentUser || !currentUser.id) {
                    alert('Please login first');
                    window.location.href = 'index.html';
                    return;
                }
        
                // Generate MongoDB-like ObjectId
                const timestamp = Math.floor(new Date().getTime() / 1000).toString(16).padStart(8, '0');
                const machineId = Math.floor(Math.random() * 16777216).toString(16).padStart(6, '0');
                const processId = Math.floor(Math.random() * 65536).toString(16).padStart(4, '0');
                const counter = Math.floor(Math.random() * 16777216).toString(16).padStart(6, '0');
                const courseId = timestamp + machineId + processId + counter;
        
                // Get form values and create course data
                const courseData = {
                    _id: courseId,
                    mentorId: currentUser.id,
                    mentor: {
                        id: currentUser.id,
                        email: currentUser.email,
                        name: currentUser.name
                    },
                    overview: {
                        title: document.querySelector('#courseTitle').value,
                        category: document.querySelector('.select-header span').textContent,
                        description: document.querySelector('#courseDescription').value
                    },
                    pricing: {
                        basic: { 
                            days: parseInt(document.querySelectorAll('.pricing-input')[0].value),
                            price: parseInt(document.querySelectorAll('.pricing-input')[3].value)
                        },
                        normal: { 
                            days: parseInt(document.querySelectorAll('.pricing-input')[1].value),
                            price: parseInt(document.querySelectorAll('.pricing-input')[4].value)
                        },
                        premium: { 
                            days: parseInt(document.querySelectorAll('.pricing-input')[2].value),
                            price: parseInt(document.querySelectorAll('.pricing-input')[5].value)
                        }
                    },
                    gallery: {
                        image: await resizeImage(document.querySelector('#imagePreview img')?.src)
                    },
                    status: "active",
                    createdAt: new Date().toISOString()
                };
        
                // Validate and send data
                const response = await fetch('http://localhost:5000/api/courses/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': currentUser.id
                    },
                    body: JSON.stringify(courseData)
                });
        
                const result = await response.json();
                
                if (result.success) {
                    let mentors = JSON.parse(localStorage.getItem('mentors')) || [];
                    const mentorIndex = mentors.findIndex(m => m.id === currentUser.id);
                    
                    if (mentorIndex !== -1) {
                        if (!mentors[mentorIndex].courses) {
                            mentors[mentorIndex].courses = [];
                        }
                        mentors[mentorIndex].courses.push(courseId);
                        localStorage.setItem('mentors', JSON.stringify(mentors));
                    }
                    
                    showSuccessMessage();
                    setTimeout(() => {
                        window.location.href = 'business.html';
                    }, 2000);
                }
        
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to create course. Please try again.');
            }
        });
    </script>
</body>
</html>